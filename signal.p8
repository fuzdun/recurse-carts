pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

px = 64
py = 40
l_px = 64
l_py = 40
perm = {}
jmp = 1.2
spd = .05
grv = .05


function _init()
    -- printh("======")
    cls()
    srand(stat(95))
    for i=0, 32 do
        add(perm, i)
    end
    shuffle(perm)
    for i=0, 32 do
        add(perm, perm[i + 1])
    end
    for i = 1, 16384 do
        x = i % 127
        y = flr(i / 127)
        -- printh(noise(x, y))
        add(noise_sample, noise(x / 4.0, y / 4.0) * 10 + 10) 
    end
end

function _update60()
    static_amt += 1
    cache_x = px
    cache_y = py
    px += (px - l_px) * 0.9
    py += (py - l_py)
    l_px = cache_x
    l_py = cache_y
    floor_y = t_border + screen_h - 2
    if btn(0) then
        px -= spd
    end
    if btn(1) then
        px += spd
    end
    if btnp(4) then
        py -= jmp
    end
    if py <= floor_y then
        py += grv
    else
        l_py = floor_y
        py = floor_y
    end
end

l_border = 40 
r_border = 102
t_border = 40 
b_border = 102
screen_w = 47 
screen_h = 47 

static_amt = 0

static_colors = {5, 6, 7}
noise_sample = {}

function _draw()

    cls()
    if px > 38 and px < 90 then
        spr(13, px, py)
    end
    -- spr(1, 32, 32, 12, 12)
    map(0, 0, 32, 32, 8, 9)
    local off = flr(time() * 300) 
    local t = flr(time())
    for xi = l_border, (l_border + screen_w) do
        for yi = t_border, (t_border + screen_h) do
            i = ((yi * 2 + off) % screen_h) * 128 + (xi * 2 + off) % screen_w + 1
            if noise_sample[i] < static_amt / 100 then
                pset(xi, yi, rnd(static_colors))
            end
        end
    end
    -- pset(px + 1, py + 2, 9)
end

function rand_range(min, max)
    local range = max - min
    local r = flr(rnd(range))
    return min + r
end

function noise(x, y)
    local x_perm = flr(x) % 32 + 1
    local y_perm = flr(y) % 32 + 1
    local x_fract = x - flr(x)
    local y_fract = y - flr(y)
    local tr = {x_fract - 1, y_fract - 1}
    local tl = {x_fract, y_fract - 1}
    local br = {x_fract - 1, y_fract}
    local bl = {x_fract, y_fract}
    local first = x_perm + 1
    local second = perm[first] + y_perm + 1
    local p_tr = perm[perm[x_perm + 1] + y_perm + 1]
    local p_tl = perm[perm[x_perm] + y_perm + 1]
    local p_br = perm[perm[x_perm + 1] + y_perm]
    local p_bl = perm[perm[x_perm] + y_perm]
    local const_tr = const_vector(p_tr)
    local const_tl = const_vector(p_tl)
    local const_br = const_vector(p_br)
    local const_bl = const_vector(p_bl)
    local dot_tr = dot(tr[1], tr[2], const_tr[1], const_tr[2])
    local dot_tl = dot(tl[1], tl[2], const_tl[1], const_tl[2])
    local dot_br = dot(br[1], br[2], const_br[1], const_br[2])
    local dot_bl = dot(bl[1], bl[2], const_bl[1], const_bl[2])
    local u = fade(x_fract)
    local v = fade(y_fract)
    return lerp(u, lerp(v, dot_bl, dot_tl), lerp(v, dot_br, dot_tr))
end

function fade(t)
	return ((6*t - 15)*t + 10)*t*t*t;
end

function lerp(t, a1, a2)
	return a1 + t*(a2-a1);
end

function const_vector(p)
    local h = p % 4
    if h == 0 then
        return {1., 1.}
    elseif h == 1 then
        return {-1., 1.}
    elseif h == 2 then
        return {-1., -1.}
    else
        return {1., -1.}
    end
end

function dot(x0, y0, x1, y1)
    return x0 * x1 + y0 * y1
end

function shuffle(tbl)
    for i=1, #tbl do
        local rnd_i = flr(rnd(#tbl)) + 1
        local temp = tbl[i]
        tbl[i] = tbl[rnd_i] 
        tbl[rnd_i] = temp
    end
end


__gfx__
00000000ddddddddddddddddddddddddf9f9f9f90000000000000000000065000000000000000000000000000000000000000000000000000000000000000000
00000000d111111111111111111111129f9f9f9f00000000000000000006650000000000000000000000000000000000000000000a0000000000000000000000
00700700d111111111111111111111120000000000000000000000000006500000000000000000000000000000000000000000000a0000000000000000000000
00077000d11111111111111111111112000000000000000000000000000650000000000000000000000000000000000000000000000000000000000000000000
00077000d11111111111111111111112000000000000000000000000000650000000000000000000000000000000000000000000000000000000000000000000
00700700d11111111111111111111112000000000000000000000000000650000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000006650000000000000000000000000000000000000000000000000000000000000000000
00000000d11111115555555511111112000000000000000000000000006500000000000000000000000000000000000000000000000000000000000000000000
00000000d11111151111111161111112666666660000000000000000066500000000000000000000000000000000000000000000000000000000000000000000
00000000d11111151111111161111112111111110000000000000000065000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111151111111161111112111111110000000000000000665000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111151111111161111112111111110000000000000000650000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111151111111161111112111111110000000000000000650000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111151111111161111112111111110000000000000000650000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111151111111161111112111111110000000000000000650000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111151111111161111112111111110000000000000000650000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111115555555511111112000000000000000000000000650000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000650000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d22222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111111111111111111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d11111112222222211111112000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000001111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000001111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000e66555816666666611e555816666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000e655558111111111111888111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000001e55581111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000001188811111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000001111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000001111111111eee11111111111111ee81100000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000111111111e6668111111111111e6658100000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000022222222e66655812222222211e6558100000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000011111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000
__gff__
0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0102020202020203000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000000000013000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100040000040013000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000404000013000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1104000000000413000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100000404000013000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1100040000040013000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3114731475751433000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2132723274743223000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
