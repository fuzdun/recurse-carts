pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

grabbed_chain = 0
grabbed_link = 2
grabbed_link_t = 0.5
junctions = {}

lppos = {20, 11}
ppos = {20, 11}
init_player_pos = {}

map_x_offset = 0
map_y_offset = 0

#include utils.p8
#include load_level.p8
#include chains.p8
#include player.p8


lvl = 1

function load_level()
    junctions = {}
    chains = {}
    tracks = {}
    cur_chain_ts = {0, 0, 0}
    cur_track_segs = {1, 1, 1}
    init_player_pos = {}
    on_ground = false
    hit_ceiling = false
    dragging_chain = false
    grabbed_chain = 0

    map_x_offset = (lvl - 1) * 16 
    map_y_offset = 0
    detect_track()
    get_player_pos()
end

function _init()
    cls()
    load_level()
    -- for j in all(tracks[1]) do
    --     printh("x: " .. j[1] .. " y: " .. j[2])
    -- end
end

function _update60()
    apply_player_input()
    apply_chain_input()
    apply_player_forces()
    apply_chain_forces()
    update_chains()
    if grabbed_chain ~= 0 then
        constrain_player_to_chain()
    end
    collide_player()
    if mget(ppos[1] / 8 + map_x_offset, ppos[2] / 8 + map_y_offset) == 39 then
        lvl += 1
        load_level()
    end
    check_death()
end

function check_line_sq_col(x0, y0, x1, y1, bx0, by0, bx1, by1)
    local a = mid(bx0, x0, bx1) == x0
    local b = mid(by0, y0, by1) == y0
    local dx = x1 - x0
    local dy = y1 - y0
    local c = sgn(dx) == 1
    local d = sgn(dy) == 1
    local x_con = a and (c and bx1 or bx0) or (c and bx0 or bx1) 
    local y_con = b and (d and by1 or by0) or (d and by0 or by1)

    local x_pct = (x_con - x0) / dx
    local new_y = y0 + dy * x_pct
    local got_x = mid(by0, new_y, by1) == new_y

    local y_pct = (y_con - y0) / dy
    local new_x = x0 + dx * y_pct
    local got_y = mid(bx0, new_x, bx1) == new_x
    if got_x and got_y then
        return x_pct < y_pct and "x_col" or "y_col"
    else
        if got_x then
            return "x_col"
        end
        if got_y then
            return "y_col"
        end
    end
    return nil
end


function _draw()
    cls()
    local map_x = 16 * (lvl - 1)
    local map_y = 0
    map(map_x, map_y, 0, 0, 16, 16)
    draw_junctions()
    erase_player_pos()
    
    draw_player()
    draw_chains()
end

function draw_player()
    spr(9, ppos[1] - 3.5, ppos[2] - 3.5)
end

chain_colors = {12, 11, 8}

function draw_chains()
    for chain_i=1, #chains do
        local chain = chains[chain_i]
        for i=1, #chain - 1 do
            local l = chain[i][2]
            local nl = chain[i + 1][2]
            circ(l[1], l[2], 1, 6)
        end
        rectfill(chain[1][2][1] - 1, chain[1][2][2] - 3, chain[1][2][1] + 2, chain[1][2][2], chain_colors[chain_i])
    end
end

function erase_player_pos()
    rectfill(init_player_pos[1],init_player_pos[2],init_player_pos[1] + 7, init_player_pos[2] + 7, 0)
end

function draw_junctions()
    for j in all(junctions) do
        rectfill(j[1],j[2],j[1] + 7, j[2] + 7, 0)
        spr(38, j[1], j[2])
    end
end

__gfx__
000000009999999999999999944f1f1111f1f44911f1f449999999999441f1111111111100000000000000000000000000000000000000000000000000000000
0000000044444449944444449441f111111f1449111f144944444444944f1f111111111100000000000000000000000000000000000000000000000000000000
007007004444444994444444944f1f1ff1f1f44911f1f449444444449441f1111f1f1f1f00777700000060000000600000006000000000000000000000000000
00077000f1f1f449944f1f1f9441f1f11f1f1449111f1449f1f1f1f1944f1f11f1f1f1f100799700000060000000600000006000000000000000000000000000
000770001f1f14499441f1f1944f1f1ff1f1f44911f1f4491f1f1f1f9441f1111f1f1f1f00799700000600000006000000060000000000000000000000000000
00700700f1f1f449944f1f1f9444444444444449111f1449f1f1f1f1944f1f114444444400777700000600000006000000060000000000000000000000000000
00000000111f14499441f111944444444444444911f1f449111111119441f111444444440000000000cccc0000bbbb0000888800000000000000000000000000
0000000011f1f449944f1f119999999999999999111f144911111111944f1f1199999999000000000cccccc00bbbbbb008888880000000000000000000000000
000000001111111199999999944f14499999999999999999999999999441f4494444444499999999ccccccccbbbbbbbb88888888000000000000000000000000
0000000011111111944444449441f449444444499444444944444444944f14490404404094444449ccccccccbbbbbbbb88888888000000000000000000000000
000000001111111194444444944f14494444444994444449444444449441f4490000000094444449ccccccccbbbbbbbb88888888000000000000000000000000
0000000011111111944f1f1f9441f4491f1f14499441f449f1f1f1f1944f144900000000944f1449ccccccccbbbbbbbb88888888000000000000000000000000
00000000111111119441f1f1944f1449f1f1f449944f14491f1f1f1f9441f449000000009441f449ccccccccbbbbbbbb88888888000000000000000000000000
00000000111111119444444494444449444444499441f44944444444944f14490000000094444449ccccccccbbbbbbbb88888888000000000000000000000000
0000000011111111944444449444444944444449944f1449444444449441f4490000000094444449ccccccccbbbbbbbb88888888000000000000000000000000
00000000111111119999999999999999999999999441f44999999999944f14490000000099999999ccccccccbbbbbbbb88888888000000000000000000000000
00000000005005000005005000000000000000000050050000888800000e600000000000eeeeeeee000000000000000000000000000000000000000000000000
0000000000500500000500500000000000000000005005000080080000ee600000282200eeeeeeee000000000000000000000000000000000000000000000000
005555550050050000050050555555005555555500500500880000880eee600002888820eeeeeeee000000000000000000000000000000000000000000000000
0050000000500555555500500000050000000000005005008000000800ee600008822820eeeeeeee000000000000000000000000000000000000000000000000
00500000005000000000005000000500000000000050050080000008000e600002282280eeeeeeee000000000000000000000000000000000000000000000000
005005550050000000000050555005005555555500500500880000880000600002888280eeeeeeee000000000000000000000000000000000000000000000000
005005000055555555555550005005000000000000500500008008000000600000288800eeeeeeee000000000000000000000000000000000000000000000000
005005000000000000000000005005000000000000500500008888000000600000000000eeeeeeee000000000000000000000000000000000000000000000000
__gff__
002d2b1315050903110000000000000000003b373d2f1907403f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0808080808080808080808080808080808080808080808080808080808080808150000000000000000000000000000000500000000000000002624241b0000071500000000001a000000000000000015152600000015001a24242424242426001500000000000000001a00000000001500000000000000000000000000000000
17270000000000000000000000000017050000000000000000000000000000071700000000000000000000000000000005000000000000000000000000000007170900002800250000000000000a001717250000001700000000000a000025001700000000000000000000000000001700090000000000000000000000000000
171818180018001800000000000000170527000000000026000000000000000717000000000000000000001500000000050000002624241a000000000000000717181828000025000000281818181817172500000013000000121616140025001709000000000000000015000000001700180029002900292929002900290000
170000001a000000000018000000001705181800000000250000000000000007171500000000000000000017090a00000500000000000000000000000000000717000000280025000028000000000a17172515000000000000150000000025001716161614000000121614181214001700000029002900290029002900290000
1700000000000000000000150000001705000000000000250000000000000007171727000000000000000003161400000500000000000000000000000000270717000000000025000028000000281817172517090000000000170000000026261728000000282800280000182800001700000000290000290029002900290000
170000000000000015000013180206170500000000000025000000000000000717031614000000001a242600000000000500000000000000000000000000120717000028000025000028000000001817172517161614000000170015282828251700000000000028000000180000001700000029000000292929002929290000
17000000000000001300000018071117050000000000002500000000000a0007170000000000000000000000000000000500000000000000000000000000000717000028000025000028000000281817172517270000000000170017262424261700002800150000000000180028001700000000000000000000000000000000
1718000000000000181818181803081705000000000000250000000018181807170000000000000000000000000000000518150000000000000000000000000717000028000025000028000018000017172517140000000000170017252828281700280018121616140012161616161700002900000029002900290000290000
1701000000000000000000000000001705000000000000250000000000000007170000000000000000000000000000000518170000000000000000000000000717000015000025000028000018280017172517000000000000170017262426001700000018000000280028000000001700002900290029000000292900290000
17060100000000000000180012190017050000000000001a0000000000000007170000000000000000000000000000000518170000000000000000000000000717000013000026000028000000001817172513282828282828170017000025001700000018000000002800000000001700002900290029002900290029290000
1711050000180000000000000013181705000000000000000000000000000007170000000000000000000000000000000518170000000000000000000000000717000000181818181818000028180017171b00000000000000170a00000025001700280018000000000000000028001700002929292929002900290000290000
171105000000000000000000001818170500000000000000000000000a00000717000000000000000000000000000000051817000000000000000000000000071700001818181818181818180000001717000b000000000000131800000025001716161616161400121616181616001700000000000000000000000000000000
1711050000000000180000000206061705000000000000000000020606180206170000000000000000000000000000000518170000000000000000000000000717001800000000000000000028282817170015000000000000000000000025001700000000002800280000180000001700000000000000000000000000000000
1711051812161400000000000711111705000000000000000000030808180711170000000000000000000000000000000518130000000000000000000000000717001800000000000000000000000017170000000000002624242424242426001700000000000028000000180000001700000000000000000000000000000000
171105181818180000090000071111170500000900000000000000000018071117000000000000000000000000000000051800090000000a00000000000b000717161400000000000000000000002717170000000000000000000000000000001727000000000000000000180000001700000000000000000000000000000000
1706060606060606060606060606061706060606060606060606060606060606130000000000000000000000000000000606060606060606060606060606060617000000000000000000000012161613130000000000000000000000000000001316161400000000000000181818181300000000000000000000000000000000
